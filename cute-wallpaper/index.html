<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Cute Wallpaper</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{width:100%;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",system-ui,sans-serif}
    body{cursor:default;user-select:none;-webkit-user-select:none}

    /* === background === */
    #bg{position:fixed;inset:0;z-index:0;transition:background 1.2s ease}

    /* themes */
    .theme-sakura  #bg{background:linear-gradient(160deg,#ffe0ec 0%,#ffd6e0 30%,#ffc8d6 60%,#ffb8cc 100%)}
    .theme-sky     #bg{background:linear-gradient(160deg,#d0e8ff 0%,#b8deff 30%,#a0d4ff 60%,#88caff 100%)}
    .theme-sunset  #bg{background:linear-gradient(160deg,#ffe0b2 0%,#ffccbc 30%,#f8bbd0 60%,#e1bee7 100%)}
    .theme-forest  #bg{background:linear-gradient(160deg,#c8e6c9 0%,#b2dfdb 30%,#b3e5fc 60%,#dcedc8 100%)}
    .theme-night   #bg{background:linear-gradient(160deg,#1a1a2e 0%,#16213e 30%,#0f3460 60%,#1a1a2e 100%)}
    .theme-lavender #bg{background:linear-gradient(160deg,#e8daef 0%,#d7bde2 30%,#d2b4de 60%,#c39bd3 100%)}

    /* === canvas for animations === */
    #canvas{position:fixed;inset:0;z-index:1;pointer-events:none}

    /* === click sparkle === */
    .sparkle{position:fixed;z-index:5;pointer-events:none;font-size:20px;animation:sparkle-up .9s ease-out forwards}
    @keyframes sparkle-up{
      0%{opacity:1;transform:translateY(0) scale(1) rotate(0deg)}
      100%{opacity:0;transform:translateY(-60px) scale(.4) rotate(30deg)}
    }

    /* === UI panel === */
    #panel{
      position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:10;
      display:flex;gap:8px;align-items:center;
      background:rgba(255,255,255,.75);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
      border:1px solid rgba(255,255,255,.5);border-radius:999px;
      padding:8px 16px;box-shadow:0 8px 32px rgba(0,0,0,.08);
      transition:opacity .4s ease;
    }
    .theme-night #panel{background:rgba(30,30,50,.7);border-color:rgba(255,255,255,.12)}

    #panel.hidden{opacity:0;pointer-events:none}

    .theme-btn{
      width:32px;height:32px;border-radius:50%;border:2px solid rgba(255,255,255,.6);
      cursor:pointer;transition:.2s;position:relative;
    }
    .theme-btn:hover{transform:scale(1.2)}
    .theme-btn.active{border-color:#fff;box-shadow:0 0 10px rgba(255,255,255,.5)}
    .theme-btn[data-theme="sakura"]{background:linear-gradient(135deg,#ffb8cc,#ffe0ec)}
    .theme-btn[data-theme="sky"]{background:linear-gradient(135deg,#88caff,#d0e8ff)}
    .theme-btn[data-theme="sunset"]{background:linear-gradient(135deg,#e1bee7,#ffe0b2)}
    .theme-btn[data-theme="forest"]{background:linear-gradient(135deg,#b2dfdb,#c8e6c9)}
    .theme-btn[data-theme="night"]{background:linear-gradient(135deg,#0f3460,#1a1a2e)}
    .theme-btn[data-theme="lavender"]{background:linear-gradient(135deg,#c39bd3,#e8daef)}

    .sep{width:1px;height:20px;background:rgba(0,0,0,.1);margin:0 4px}
    .theme-night .sep{background:rgba(255,255,255,.15)}

    .icon-btn{
      width:36px;height:36px;border-radius:50%;border:none;
      background:rgba(255,255,255,.4);cursor:pointer;font-size:16px;
      display:flex;align-items:center;justify-content:center;transition:.2s;
    }
    .icon-btn:hover{background:rgba(255,255,255,.7);transform:scale(1.1)}
    .theme-night .icon-btn{background:rgba(255,255,255,.12);color:#fff}
    .theme-night .icon-btn:hover{background:rgba(255,255,255,.25)}

    /* === time display === */
    #clock{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:3;
      text-align:center;pointer-events:none;
      padding:clamp(20px,4vw,40px) clamp(30px,6vw,64px);
      border-radius:clamp(24px,4vw,40px);
      background:radial-gradient(ellipse at 50% 40%,rgba(255,255,255,.35) 0%,rgba(255,220,240,.2) 50%,rgba(255,255,255,.08) 100%);
      backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);
      border:1.5px solid rgba(255,255,255,.45);
      box-shadow:
        0 4px 30px rgba(255,182,210,.25),
        0 8px 60px rgba(255,160,200,.12),
        inset 0 1px 0 rgba(255,255,255,.5);
      animation:clock-float 6s ease-in-out infinite;
      transition:opacity .4s ease;
    }
    #clock.clock-hidden{opacity:0;pointer-events:none}
    @keyframes clock-float{
      0%,100%{transform:translate(-50%,-50%) translateY(0)}
      50%{transform:translate(-50%,-50%) translateY(-6px)}
    }

    #clock-time{
      font-size:clamp(52px,13vw,128px);font-weight:200;letter-spacing:.05em;
      color:rgba(255,255,255,.95);
      text-shadow:
        0 0 20px rgba(255,200,220,.5),
        0 0 50px rgba(255,180,210,.2),
        0 2px 8px rgba(0,0,0,.04);
    }
    #clock-sec{
      display:inline-block;
      font-size:clamp(22px,5vw,48px);font-weight:300;
      color:rgba(255,255,255,.5);
      vertical-align:super;margin-left:4px;
      letter-spacing:.02em;
    }
    #clock-date{
      font-size:clamp(13px,2.8vw,20px);font-weight:400;letter-spacing:.12em;
      color:rgba(255,255,255,.65);margin-top:clamp(4px,1vw,10px);
    }
    #clock-greeting{
      font-size:clamp(11px,2.2vw,16px);font-weight:400;letter-spacing:.1em;
      color:rgba(255,210,230,.7);margin-top:clamp(2px,.6vw,6px);
    }

    /* night theme overrides */
    .theme-night #clock{
      background:radial-gradient(ellipse at 50% 40%,rgba(30,40,80,.5) 0%,rgba(15,20,50,.35) 50%,rgba(10,10,30,.2) 100%);
      border-color:rgba(100,140,255,.2);
      box-shadow:
        0 4px 30px rgba(80,100,200,.2),
        0 8px 60px rgba(60,80,180,.1),
        inset 0 1px 0 rgba(255,255,255,.1);
    }
    .theme-night #clock-time{
      color:rgba(200,210,255,.8);
      text-shadow:0 0 20px rgba(100,140,255,.35),0 0 50px rgba(80,120,255,.15),0 2px 8px rgba(0,0,0,.1);
    }
    .theme-night #clock-sec{color:rgba(180,200,255,.35)}
    .theme-night #clock-date{color:rgba(200,210,255,.45)}
    .theme-night #clock-greeting{color:rgba(140,160,255,.45)}

    /* === Settings panel === */
    #settings-overlay{
      position:fixed;inset:0;z-index:50;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.2);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
      opacity:0;pointer-events:none;transition:opacity .35s ease;
    }
    #settings-overlay.open{opacity:1;pointer-events:auto}

    #settings{
      width:min(360px,90vw);max-height:80vh;overflow-y:auto;
      background:rgba(255,255,255,.82);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
      border:1.5px solid rgba(255,255,255,.6);border-radius:28px;
      padding:28px 24px 20px;
      box-shadow:0 12px 48px rgba(255,180,210,.2),0 2px 12px rgba(0,0,0,.06);
      transform:translateY(20px) scale(.96);transition:transform .35s ease;
    }
    #settings-overlay.open #settings{transform:translateY(0) scale(1)}

    .theme-night #settings{
      background:rgba(25,25,50,.85);border-color:rgba(100,140,255,.2);
      box-shadow:0 12px 48px rgba(60,80,180,.2),0 2px 12px rgba(0,0,0,.15);
    }

    #settings-title{
      font-size:16px;font-weight:600;letter-spacing:.06em;text-align:center;
      color:rgba(180,100,140,.85);margin-bottom:20px;
    }
    .theme-night #settings-title{color:rgba(160,170,220,.8)}

    .s-row{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 0;border-bottom:1px solid rgba(0,0,0,.05);
    }
    .s-row:last-child{border-bottom:none}
    .theme-night .s-row{border-bottom-color:rgba(255,255,255,.06)}

    .s-label{font-size:13px;font-weight:500;color:rgba(80,60,80,.75);letter-spacing:.03em}
    .theme-night .s-label{color:rgba(200,200,230,.6)}

    /* toggle switch */
    .toggle{
      position:relative;width:44px;height:24px;border-radius:12px;
      background:rgba(0,0,0,.1);border:none;cursor:pointer;transition:.3s;flex-shrink:0;
    }
    .toggle::after{
      content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;
      border-radius:50%;background:#fff;transition:.3s;
      box-shadow:0 1px 4px rgba(0,0,0,.1);
    }
    .toggle.on{background:linear-gradient(135deg,#ffb8cc,#ffa0c0)}
    .toggle.on::after{left:23px}
    .theme-night .toggle{background:rgba(255,255,255,.1)}
    .theme-night .toggle.on{background:linear-gradient(135deg,#6080d0,#8090e0)}

    /* dropdown select */
    .s-select{
      font-size:12px;padding:5px 10px;border-radius:12px;border:1px solid rgba(0,0,0,.1);
      background:rgba(255,255,255,.6);color:rgba(80,60,80,.85);cursor:pointer;
      font-family:inherit;outline:none;
    }
    .s-select:focus{border-color:rgba(255,160,200,.5)}
    .theme-night .s-select{
      background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.12);color:rgba(200,200,230,.8);
    }

    #settings-close{
      display:block;margin:18px auto 0;padding:8px 28px;border:none;border-radius:999px;
      background:linear-gradient(135deg,rgba(255,184,204,.6),rgba(255,160,192,.4));
      color:rgba(160,80,120,.8);font-size:13px;font-weight:600;letter-spacing:.06em;
      cursor:pointer;transition:.25s;
    }
    #settings-close:hover{transform:scale(1.05);background:linear-gradient(135deg,rgba(255,184,204,.8),rgba(255,160,192,.6))}
    .theme-night #settings-close{
      background:linear-gradient(135deg,rgba(80,100,180,.4),rgba(60,80,160,.3));
      color:rgba(180,190,230,.8);
    }

    /* fullscreen */
    .fullscreen #panel{bottom:30px}
  </style>
</head>
<body class="theme-sakura">

  <div id="bg"></div>
  <canvas id="canvas"></canvas>

  <div id="clock">
    <div id="clock-time"><span id="clock-hm"></span><span id="clock-sec"></span></div>
    <div id="clock-date"></div>
    <div id="clock-greeting"></div>
  </div>

  <div id="panel">
    <button class="theme-btn active" data-theme="sakura" title="Sakura"></button>
    <button class="theme-btn" data-theme="sky" title="Sky"></button>
    <button class="theme-btn" data-theme="sunset" title="Sunset"></button>
    <button class="theme-btn" data-theme="forest" title="Forest"></button>
    <button class="theme-btn" data-theme="night" title="Night"></button>
    <button class="theme-btn" data-theme="lavender" title="Lavender"></button>
    <span class="sep"></span>
    <button class="icon-btn" id="btn-settings" title="Settings">&#x2699;</button>
    <button class="icon-btn" id="btn-fullscreen" title="Fullscreen">&#x26F6;</button>
    <button class="icon-btn" id="btn-hide" title="Hide UI">&#x25BD;</button>
  </div>

  <!-- Settings overlay -->
  <div id="settings-overlay">
    <div id="settings">
      <div id="settings-title">Settings</div>
      <div class="s-row">
        <span class="s-label">Show Clock</span>
        <button class="toggle on" id="s-clock"></button>
      </div>
      <div class="s-row">
        <span class="s-label">Auto-hide UI Bar</span>
        <button class="toggle on" id="s-autohide"></button>
      </div>
      <div class="s-row">
        <span class="s-label">Particles</span>
        <button class="toggle on" id="s-particles"></button>
      </div>
      <div class="s-row">
        <span class="s-label">Particle Density</span>
        <select class="s-select" id="s-density">
          <option value="0">Low</option>
          <option value="1" selected>Medium</option>
          <option value="2">High</option>
        </select>
      </div>
      <div class="s-row">
        <span class="s-label">FPS Cap</span>
        <select class="s-select" id="s-fps">
          <option value="0">30</option>
          <option value="1" selected>60</option>
        </select>
      </div>
      <button id="settings-close">Close</button>
    </div>
  </div>

  <script>
  (() => {
    /* ======== Settings state ======== */
    const DENSITY_MAP = [18, 35, 60];
    const FPS_MAP = [30, 60];
    const THEME_NAMES = ['sakura','sky','sunset','forest','night','lavender'];

    const cfg = {
      showClock: true,
      autoHideUI: true,
      particlesOn: true,
      particleDensity: 1,
      theme: 0,
      fpsCap: 1,
    };

    // Load from localStorage (fallback when not in Lively)
    function loadSettings() {
      try {
        const saved = JSON.parse(localStorage.getItem('cw-settings'));
        if (saved) Object.assign(cfg, saved);
      } catch(_) {}
    }
    function saveSettings() {
      localStorage.setItem('cw-settings', JSON.stringify(cfg));
    }
    loadSettings();

    /* ======== Theme ======== */
    const THEMES = {
      sakura:   { particles: ['ðŸŒ¸','ðŸ’®','ðŸ©·','âœ¿','â€'], bgAlpha: .12 },
      sky:      { particles: ['â˜ï¸','ðŸ•Šï¸','ðŸ’™','âœ¦','ðŸ«§'], bgAlpha: .10 },
      sunset:   { particles: ['ðŸŒ…','ðŸ§¡','âœ¨','ðŸ¦‹','ðŸŒ»'], bgAlpha: .10 },
      forest:   { particles: ['ðŸƒ','ðŸŒ¿','ðŸ’š','ðŸ¦Š','ðŸ€'], bgAlpha: .10 },
      night:    { particles: ['â­','ðŸŒ™','ðŸ’«','âœ¨','ðŸª'], bgAlpha: .06 },
      lavender: { particles: ['ðŸ’œ','ðŸ¦„','ðŸ”®','ðŸª»','ðŸ’'], bgAlpha: .10 },
    };

    let currentTheme = THEME_NAMES[cfg.theme] || 'sakura';
    const body = document.body;

    function applyTheme(name) {
      // Preserve fullscreen class
      const isFull = body.classList.contains('fullscreen');
      body.className = 'theme-' + name;
      if (isFull) body.classList.add('fullscreen');
      currentTheme = name;
      cfg.theme = THEME_NAMES.indexOf(name);
      saveSettings();
      document.querySelectorAll('.theme-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.theme === name);
      });
      resetParticles();
    }

    document.querySelectorAll('.theme-btn').forEach(b => {
      b.addEventListener('click', () => applyTheme(b.dataset.theme));
    });

    applyTheme(currentTheme);

    /* ======== Clock ======== */
    const clockEl = document.getElementById('clock');
    const DAYS = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    function getGreeting(h) {
      if (h >= 5 && h < 10) return 'Good Morning';
      if (h >= 10 && h < 12) return 'Have a Nice Day';
      if (h >= 12 && h < 14) return 'Lunch Time';
      if (h >= 14 && h < 17) return 'Good Afternoon';
      if (h >= 17 && h < 21) return 'Good Evening';
      return 'Good Night';
    }
    function updateClock() {
      if (!cfg.showClock) return;
      const now = new Date();
      const h = String(now.getHours()).padStart(2,'0');
      const m = String(now.getMinutes()).padStart(2,'0');
      const s = String(now.getSeconds()).padStart(2,'0');
      document.getElementById('clock-hm').textContent = h + ':' + m;
      document.getElementById('clock-sec').textContent = s;
      const mo = now.getMonth()+1;
      const d = now.getDate();
      const day = DAYS[now.getDay()];
      document.getElementById('clock-date').textContent = mo + '/' + d + ' (' + day + ')';
      document.getElementById('clock-greeting').textContent = getGreeting(now.getHours());
    }
    function applyClockVisibility() {
      clockEl.classList.toggle('clock-hidden', !cfg.showClock);
      if (cfg.showClock) updateClock();
    }
    applyClockVisibility();
    updateClock();
    setInterval(updateClock, 1000);

    /* ======== Canvas particles ======== */
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let W, H;
    let particles = [];
    let particleCount = DENSITY_MAP[cfg.particleDensity];

    function resize() {
      W = canvas.width = window.innerWidth;
      H = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    class Particle {
      constructor() { this.reset(true); }
      reset(init) {
        const theme = THEMES[currentTheme];
        this.emoji = theme.particles[Math.floor(Math.random() * theme.particles.length)];
        this.size = 14 + Math.random() * 22;
        this.x = Math.random() * W;
        this.y = init ? Math.random() * H : -40;
        this.vx = (Math.random() - .5) * .4;
        this.vy = .3 + Math.random() * .6;
        this.rot = Math.random() * Math.PI * 2;
        this.rotV = (Math.random() - .5) * .02;
        this.alpha = .3 + Math.random() * .5;
        this.wobblePhase = Math.random() * Math.PI * 2;
        this.wobbleSpeed = .005 + Math.random() * .01;
        this.wobbleAmp = 20 + Math.random() * 30;
      }
      update() {
        this.wobblePhase += this.wobbleSpeed;
        this.x += this.vx + Math.sin(this.wobblePhase) * .3;
        this.y += this.vy;
        this.rot += this.rotV;
        if (this.y > H + 40 || this.x < -40 || this.x > W + 40) this.reset(false);
      }
      draw() {
        ctx.save();
        ctx.globalAlpha = this.alpha;
        ctx.translate(this.x, this.y);
        ctx.rotate(this.rot);
        ctx.font = this.size + 'px serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(this.emoji, 0, 0);
        ctx.restore();
      }
    }

    function resetParticles() {
      particleCount = DENSITY_MAP[cfg.particleDensity];
      particles = [];
      if (!cfg.particlesOn) return;
      for (let i = 0; i < particleCount; i++) particles.push(new Particle());
    }

    /* ======== Animation loop with FPS cap + visibility pause ======== */
    let animId = null;
    let lastFrame = 0;
    let paused = false;

    function animate(ts) {
      animId = requestAnimationFrame(animate);
      if (paused) return;
      const interval = 1000 / FPS_MAP[cfg.fpsCap];
      if (ts - lastFrame < interval) return;
      lastFrame = ts;
      ctx.clearRect(0, 0, W, H);
      if (cfg.particlesOn) {
        for (const p of particles) { p.update(); p.draw(); }
      }
    }
    resetParticles();
    animId = requestAnimationFrame(animate);

    // Pause when tab/wallpaper hidden
    document.addEventListener('visibilitychange', () => {
      paused = document.visibilityState === 'hidden';
    });

    /* ======== Click sparkle ======== */
    const CLICK_EMOJIS = ['ðŸ’–','âœ¨','ðŸŒŸ','ðŸ’«','â­','ðŸ©·','ðŸ’œ','ðŸ’™','ðŸ’š','ðŸ§¡'];
    document.addEventListener('click', e => {
      if (e.target.closest('#panel') || e.target.closest('#settings-overlay')) return;
      for (let i = 0; i < 4; i++) {
        const el = document.createElement('div');
        el.className = 'sparkle';
        el.textContent = CLICK_EMOJIS[Math.floor(Math.random() * CLICK_EMOJIS.length)];
        el.style.left = (e.clientX + (Math.random()-0.5)*40) + 'px';
        el.style.top  = (e.clientY + (Math.random()-0.5)*20) + 'px';
        el.style.fontSize = (16 + Math.random()*14) + 'px';
        document.body.appendChild(el);
        el.addEventListener('animationend', () => el.remove());
      }
    });

    /* ======== Fullscreen ======== */
    document.getElementById('btn-fullscreen').addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(()=>{});
        body.classList.add('fullscreen');
      } else {
        document.exitFullscreen();
        body.classList.remove('fullscreen');
      }
    });
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) body.classList.remove('fullscreen');
    });

    /* ======== Auto-hide UI ======== */
    const panel = document.getElementById('panel');
    let hideTimeout;
    function startAutoHide() {
      clearTimeout(hideTimeout);
      if (cfg.autoHideUI) {
        hideTimeout = setTimeout(() => panel.classList.add('hidden'), 6000);
      }
    }
    document.getElementById('btn-hide').addEventListener('click', () => {
      panel.classList.add('hidden');
    });
    document.addEventListener('mousemove', () => {
      panel.classList.remove('hidden');
      startAutoHide();
    });
    document.addEventListener('touchstart', () => {
      if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        startAutoHide();
      }
    });
    if (cfg.autoHideUI) startAutoHide();

    /* ======== Settings panel ======== */
    const overlay = document.getElementById('settings-overlay');
    const sClock = document.getElementById('s-clock');
    const sAutohide = document.getElementById('s-autohide');
    const sParticles = document.getElementById('s-particles');
    const sDensity = document.getElementById('s-density');
    const sFps = document.getElementById('s-fps');

    // Sync UI to current cfg
    function syncSettingsUI() {
      sClock.classList.toggle('on', cfg.showClock);
      sAutohide.classList.toggle('on', cfg.autoHideUI);
      sParticles.classList.toggle('on', cfg.particlesOn);
      sDensity.value = cfg.particleDensity;
      sFps.value = cfg.fpsCap;
    }
    syncSettingsUI();

    document.getElementById('btn-settings').addEventListener('click', () => {
      syncSettingsUI();
      overlay.classList.add('open');
    });
    document.getElementById('settings-close').addEventListener('click', () => {
      overlay.classList.remove('open');
    });
    overlay.addEventListener('click', e => {
      if (e.target === overlay) overlay.classList.remove('open');
    });

    // Toggle helpers
    function toggleBtn(el, key) {
      el.addEventListener('click', () => {
        cfg[key] = !cfg[key];
        el.classList.toggle('on', cfg[key]);
        applySetting(key, cfg[key]);
        saveSettings();
      });
    }
    toggleBtn(sClock, 'showClock');
    toggleBtn(sAutohide, 'autoHideUI');
    toggleBtn(sParticles, 'particlesOn');

    sDensity.addEventListener('change', () => {
      cfg.particleDensity = parseInt(sDensity.value);
      applySetting('particleDensity', cfg.particleDensity);
      saveSettings();
    });
    sFps.addEventListener('change', () => {
      cfg.fpsCap = parseInt(sFps.value);
      saveSettings();
    });

    /* ======== applySetting (shared by UI + Lively) ======== */
    function applySetting(key, val) {
      switch (key) {
        case 'showClock':
          cfg.showClock = val;
          applyClockVisibility();
          break;
        case 'autoHideUI':
          cfg.autoHideUI = val;
          if (val) startAutoHide();
          else { clearTimeout(hideTimeout); panel.classList.remove('hidden'); }
          break;
        case 'particlesOn':
          cfg.particlesOn = val;
          if (!val) { particles = []; ctx.clearRect(0, 0, W, H); }
          else resetParticles();
          break;
        case 'particleDensity':
          cfg.particleDensity = val;
          if (cfg.particlesOn) resetParticles();
          break;
        case 'theme':
          cfg.theme = val;
          applyTheme(THEME_NAMES[val] || 'sakura');
          break;
        case 'fpsCap':
          cfg.fpsCap = val;
          break;
      }
      saveSettings();
      syncSettingsUI();
    }

    /* ======== Lively Wallpaper integration ======== */
    // Lively sends property changes via window.livelyPropertyListener
    window.livelyPropertyListener = function(name, val) {
      applySetting(name, val);
    };

    // Also listen for postMessage (some Lively versions use this)
    window.addEventListener('message', e => {
      if (e.data && typeof e.data === 'object' && e.data.livelyProperty) {
        applySetting(e.data.livelyProperty, e.data.value);
      }
    });

  })();
  </script>
</body>
</html>
